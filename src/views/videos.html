<!DOCTYPE html>
<html>
<head>
  <title>Web Speech API demo</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .container {
      margin-bottom: 30px;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .transcription {
      margin-top: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 4px;
      min-height: 100px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      margin: 10px 0;
      color: #666;
    }
    .error {
      color: #ff0000;
      margin: 10px 0;
    }
    .interim {
      color: #666;
      font-style: italic;
    }
    .video-container {
      margin-top: 30px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 4px;
    }
    .video-list {
      margin-top: 10px;
    }
    .video-item {
      margin: 10px 0;
      padding: 10px;
      background-color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .video-item:hover {
      background-color: #e0e0e0;
    }
    video {
      width: 100%;
      max-width: 800px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>音声文字起こし</h1>
  
  <div class="container">
    <div class="controls">
      <button id="startButton" onclick="startRecognition()">音声認識開始</button>
      <button id="stopButton" onclick="stopRecognition()" disabled>音声認識停止</button>
      <button id="clearButton" onclick="clearTranscription()">クリア</button>
    </div>
    
    <div class="status" id="status">準備完了</div>
    <div class="error" id="error"></div>
    
    <div class="transcription" id="transcription"></div>
  </div>

  <div class="video-container">
    <h2>動画再生</h2>
    <div class="video-list" id="videoList"></div>
    <video id="videoPlayer" controls></video>
  </div>

  <script>
    let recognition = null;
    let isRecognizing = false;
    let finalTranscript = '';
    let audioContext = null;
    let mediaStreamDestination = null;
    let mediaElementSource = null;
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const status = document.getElementById('status');
    const error = document.getElementById('error');
    const transcription = document.getElementById('transcription');
    const videoPlayer = document.getElementById('videoPlayer');

    // 動画の音声ストリームを取得して認識を開始
    async function startRecognitionFromVideo() {
      if (isRecognizing) {
        return;
      }

      try {
        // AudioContextの初期化
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        mediaStreamDestination = audioContext.createMediaStreamDestination();
        
        // 動画の音声をMediaStreamDestinationに接続
        mediaElementSource = audioContext.createMediaElementSource(videoPlayer);
        mediaElementSource.connect(mediaStreamDestination);
        mediaElementSource.connect(audioContext.destination); // スピーカー出力も維持

        // Web Speech APIの初期化
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.maxAlternatives = 1;

        // 音声認識の結果を処理
        recognition.onresult = (event) => {
          let interimTranscript = '';

          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += transcript + '\n';
              updateTranscription(finalTranscript);
            } else {
              interimTranscript += transcript;
              updateTranscription(finalTranscript + '\n' + interimTranscript);
            }
          }
        };

        // 音声認識の開始
        recognition.onstart = () => {
          isRecognizing = true;
          startButton.disabled = true;
          stopButton.disabled = false;
          status.textContent = '音声認識中...';
          error.textContent = '';
        };

        // 音声認識の終了
        recognition.onend = () => {
          if (isRecognizing) {
            try {
              recognition.start(mediaStreamDestination.stream.getAudioTracks()[0]);
            } catch (e) {
              error.textContent = `音声認識の再開に失敗しました: ${e.message}`;
              isRecognizing = false;
              startButton.disabled = false;
              stopButton.disabled = true;
            }
          } else {
            startButton.disabled = false;
            stopButton.disabled = true;
            status.textContent = '準備完了';
          }
        };

        // エラー処理
        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          if (event.error === 'no-speech') {
            try {
              recognition.start(mediaStreamDestination.stream.getAudioTracks()[0]);
            } catch (e) {
              error.textContent = `音声認識の再開に失敗しました: ${e.message}`;
            }
          } else {
            error.textContent = `エラーが発生しました: ${event.error}`;
            isRecognizing = false;
            startButton.disabled = false;
            stopButton.disabled = true;
          }
        };

        // 動画の音声ストリームを使用して認識を開始
        videoPlayer.play();
        recognition.start(mediaStreamDestination.stream.getAudioTracks()[0]);

      } catch (e) {
        error.textContent = `音声認識を開始できません: ${e.message}`;
        console.error('Error starting recognition:', e);
      }
    }

    function stopRecognition() {
      if (recognition) {
        isRecognizing = false;
        recognition.stop();
        
        // 音声ストリームの接続を解除
        if (mediaElementSource) {
          mediaElementSource.disconnect();
        }
        if (audioContext) {
          audioContext.close();
        }
      }
    }

    function clearTranscription() {
      finalTranscript = '';
      transcription.textContent = '';
      error.textContent = '';
    }

    function updateTranscription(text) {
      transcription.textContent = text;
      // 自動スクロール
      transcription.scrollTop = transcription.scrollHeight;
    }

    // 動画リストの取得と表示
    async function loadVideos() {
      try {
        const response = await fetch('/api/videos');
        const videos = await response.json();
        const videoList = document.getElementById('videoList');
        const videoPlayer = document.getElementById('videoPlayer');

        videos.forEach(video => {
          const videoItem = document.createElement('div');
          videoItem.className = 'video-item';
          videoItem.textContent = video.name;
          videoItem.onclick = () => {
            videoPlayer.src = `/tmp/${video.name}`;
            videoPlayer.play();
            // 動画クリック時に音声認識を開始
            startRecognitionFromVideo();
          };
          videoList.appendChild(videoItem);
        });
      } catch (error) {
        console.error('動画リストの取得に失敗しました:', error);
      }
    }

    // ページ読み込み時に動画リストを取得
    window.addEventListener('load', loadVideos);
  </script>
</body>
</html> 